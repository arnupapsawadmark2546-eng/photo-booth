<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MILKBOX STUDIO</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background-color: #fafafa;
      color: #333;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    /* --- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏õ --- */
    .app-title-box {
      text-align: center;
      margin-bottom: 25px;
    }
    .main-title {
      font-weight: 800;
      font-size: 24px;
      letter-spacing: 2px;
      margin: 0;
      color: #000;
    }
    .sub-title {
      font-weight: 400;
      font-size: 12px;
      color: #666;
      letter-spacing: 1px;
      margin-top: 5px;
    }
    /* ------------------- */

    /* ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞ Overlay */
    .camera-wrapper {
      position: relative;
      width: 100%;
      max-width: 350px;
      margin-bottom: 20px;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 15px 40px rgba(0,0,0,0.1);
      background: #000;
    }
    
    video {
      width: 100%;
      display: block;
      transform: scaleX(-1); /* ‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏à‡∏≠‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô */
    }

    /* Overlay ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á */
    #cameraOverlay {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.3);
      color: white;
      pointer-events: none; /* ‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏∞‡∏•‡∏∏‡πÑ‡∏î‡πâ */
      opacity: 0;
      transition: opacity 0.3s;
    }
    #cameraOverlay.active { opacity: 1; }

    #countdownNum {
      font-size: 80px;
      font-weight: 800;
      text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    #photoCounterText {
      font-size: 16px;
      font-weight: 600;
      background: rgba(255,255,255,0.2);
      padding: 5px 15px;
      border-radius: 20px;
      margin-top: 10px;
    }

    /* ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î (Control Group) */
    .control-group {
      background: white;
      padding: 12px;
      border-radius: 16px;
      width: 100%;
      max-width: 360px;
      margin-bottom: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      text-align: center;
    }

    .label {
      font-size: 10px;
      color: #aaa;
      margin-bottom: 6px;
      display: block;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å options */
    .option-btn {
      border: 1px solid transparent;
      padding: 8px 12px;
      margin: 2px;
      border-radius: 10px;
      font-size: 12px;
      cursor: pointer;
      background: #f4f4f4;
      color: #666;
      transition: all 0.2s ease;
    }
    .option-btn.active {
      background: #222;
      color: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* ‡πÅ‡∏ñ‡∏ß‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏´‡∏•‡∏±‡∏Å */
    .main-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin: 20px 0;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏ß‡∏á‡∏Å‡∏•‡∏° (Auto Snap) */
    .auto-snap-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff6b6b, #ee5253);
      border: 4px solid #fff;
      box-shadow: 0 10px 25px rgba(238, 82, 83, 0.4);
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
      text-transform: uppercase;
      transition: transform 0.1s, filter 0.2s;
    }
    .auto-snap-btn:active { transform: scale(0.95); }
    /* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡πà‡∏≤‡∏¢ */
    .auto-snap-btn.capturing {
        background: #ccc;
        box-shadow: none;
        pointer-events: none;
        font-size: 12px;
    }

    .icon-btn {
        background: white;
        border: none;
        width: 50px; height: 50px;
        border-radius: 50%;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        cursor: pointer;
        color: #333;
        font-size: 20px;
        transition: 0.2s;
    }
    .icon-btn:hover { background: #f0f0f0; }

    /* Input ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
    input[type="text"] {
      border: none;
      background: #fff;
      padding: 15px;
      border-radius: 12px;
      width: 100%;
      max-width: 300px;
      text-align: center;
      font-family: inherit;
      outline: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.03);
      margin-bottom: 20px;
    }
    input:focus { box-shadow: 0 4px 15px rgba(0,0,0,0.08); }

    /* ‡∏£‡∏π‡∏õ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå */
    #photos {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      min-height: 60px; /* ‡∏Å‡∏±‡∏ô layout ‡∏Ç‡∏¢‡∏±‡∏ö */
    }
    #photos img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 10px;
      transform: scaleX(-1); /* ‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡πÄ‡∏•‡πá‡∏Å */
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    #frame {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    #frame img {
      max-width: 100%;
      width: 340px;
      border-radius: 4px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    }

    /* ‡∏õ‡∏∏‡πà‡∏° Action ‡∏´‡∏•‡∏±‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à */
    .final-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    .action-button {
        padding: 12px 24px;
        border-radius: 30px;
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        border: none;
        transition: 0.2s;
    }
    .dl-btn { background: #000; color: white; }
    .share-btn { background: #fff; color: #333; border: 1px solid #ddd; }
    .share-btn:hover { background: #f9f9f9; border-color: #ccc;}

    /* ‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡πà‡∏≤‡∏¢ Auto */
    body.is-capturing .control-group,
    body.is-capturing input,
    body.is-capturing #photos,
    body.is-capturing .icon-btn {
        opacity: 0.5;
        pointer-events: none;
    }
  </style>
</head>
<body>

<div class="app-title-box">
    <h1 class="main-title">MILKBOX</h1>
    <div class="sub-title">BY IG MARKENZ9</div>
</div>

<div class="camera-wrapper">
  <video id="video" autoplay playsinline></video>
  <div id="cameraOverlay">
      <div id="countdownNum">3</div>
      <div id="photoCounterText">Photo 1/4</div>
  </div>
</div>

<div class="control-group">
  <span class="label">Layout</span>
  <button id="layout3" onclick="setLayout(3, this)" class="option-btn">Strip (3)</button>
  <button id="layout4" onclick="setLayout(4, this)" class="option-btn active">Grid (4)</button>
  <button id="layout6" onclick="setLayout(6, this)" class="option-btn">Big (6)</button>
</div>

<div class="control-group">
  <span class="label">Tone</span>
  <button onclick="setFilter('none', this)" class="option-btn active">Normal</button>
  <button onclick="setFilter('brightness(1.15) saturate(0.9) contrast(0.95)', this)" class="option-btn">üá∞üá∑ Soft</button>
  <button onclick="setFilter('brightness(1.1) contrast(1.15) sepia(0.2)', this)" class="option-btn">üáØüáµ Film</button>
  <button onclick="setFilter('brightness(1.2) contrast(1.05) grayscale(1)', this)" class="option-btn">‚òÅÔ∏è Mono</button>
</div>

<div class="control-group">
  <span class="label">Frame</span>
  <button onclick="setFrameColor('#ffffff', '#000000')" class="option-btn active">White</button>
  <button onclick="setFrameColor('#1a1a1a', '#ffffff')" class="option-btn" style="background:#333; color:#fff;">Black</button>
  <button onclick="setFrameColor('#FADADD', '#C2185B')" class="option-btn" style="background:#FADADD; color:#C2185B;">Pink</button>
  <button onclick="setFrameColor('#E3F2FD', '#1565C0')" class="option-btn" style="background:#E3F2FD; color:#1565C0;">Blue</button>
</div>

<div class="main-controls">
  <button onclick="startCamera()" class="icon-btn" title="Open Camera"><i class="fas fa-camera"></i></button>
  <div id="autoSnapBtn" class="auto-snap-btn" onclick="startAutoCapture()">
      AUTO SNAP
  </div>
  <button onclick="resetApp()" class="icon-btn" title="Reset"><i class="fas fa-redo"></i></button>
</div>

<input id="captionInput" type="text" placeholder="Add a caption..." oninput="updateCaption()">

<div id="photos"></div>
<div id="frame"></div>

<script>
  const video = document.getElementById("video");
  const photosDiv = document.getElementById("photos");
  const frameDiv = document.getElementById("frame");
  const captionInput = document.getElementById("captionInput");
  const cameraOverlay = document.getElementById("cameraOverlay");
  const countdownNum = document.getElementById("countdownNum");
  const photoCounterText = document.getElementById("photoCounterText");
  const autoSnapBtn = document.getElementById("autoSnapBtn");

  // State Variables
  let photos = [];
  let maxPhotos = 4; 
  let currentLayout = 4;
  let currentFilter = 'none';
  let frameBg = '#ffffff';
  let frameText = '#000000';
  let is Capturing = false; // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á
  function startCamera() {
    navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720, facingMode: "user" } })
      .then(stream => { video.srcObject = stream; })
      .catch(err => alert("Cannot access camera. Please allow permission."));
  }

  // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ñ‡πà‡∏≤‡∏¢ Auto ---
  function startAutoCapture() {
    if (isCapturing) return; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥
    if (!video.srcObject) { alert("Please open camera first!"); return; }
    
    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
    resetApp(false); 
    
    isCapturing = true;
    document.body.classList.add('is-capturing'); // ‡πÄ‡∏û‡∏¥‡πà‡∏° class ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πá‡∏≠‡∏Å UI ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
    autoSnapBtn.classList.add('capturing');
    autoSnapBtn.innerText = "STOP"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡∏´‡∏¢‡∏∏‡∏î (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î ‡πÅ‡∏ï‡πà‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô)

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 1
    runCaptureSequence(0);
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏π‡∏õ
  function runCaptureSequence(index) {
    // ‡∏ñ‡πâ‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏à‡∏ö‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£
    if (index >= maxPhotos) {
        finishAutoCapture();
        return;
    }

    // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà
    photoCounterText.innerText = `Photo ${index + 1}/${maxPhotos}`;
    cameraOverlay.classList.add('active'); // ‡πÅ‡∏™‡∏î‡∏á Overlay

    // 2. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    let count = 3;
    countdownNum.innerText = count;
    
    const countdownTimer = setInterval(() => {
        count--;
        if (count > 0) {
            countdownNum.innerText = count;
        } else {
            // 3. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏ö‡∏ñ‡∏∂‡∏á 0
            clearInterval(countdownTimer);
            countdownNum.innerText = "CHEESE!";
            
            // ‡∏£‡∏≠‡πÅ‡∏õ‡πä‡∏ö‡∏ô‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ñ‡πà‡∏≤‡∏¢ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ CHEESE)
            setTimeout(() => {
                takePhoto(true); // ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ (true = ‡∏°‡∏≤‡∏à‡∏≤‡∏Å auto mode)
                cameraOverlay.classList.remove('active'); // ‡∏ã‡πà‡∏≠‡∏ô Overlay

                // 4. ‡∏£‡∏≠ 1.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                setTimeout(() => {
                    runCaptureSequence(index + 1); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ã‡πâ‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                }, 1500); 

            }, 500);
        }
    }, 1000); // ‡∏ô‡∏±‡∏ö‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  }

  // ‡∏à‡∏ö‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£ Auto Capture
  function finishAutoCapture() {
    isCapturing = false;
    document.body.classList.remove('is-capturing');
    autoSnapBtn.classList.remove('capturing');
    autoSnapBtn.innerText = "AUTO SNAP";
  }


  // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Layout, Filter, Frame) ---
  function setLayout(num, btn) {
    if (isCapturing) return;
    if (photos.length > 0 && !confirm("Changing layout will reset current photos.")) return;
    resetApp();
    maxPhotos = num;
    currentLayout = num;
    document.querySelectorAll('#layout3, #layout4, #layout6').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }

  function setFilter(val, btn) {
    currentFilter = val;
    video.style.filter = val;
    if(btn) {
      btn.parentElement.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }
  }

  function setFrameColor(bg, txt) {
    frameBg = bg;
    frameText = txt;
    if(btn) {
      btn.parentElement.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }
    if (photos.length === maxPhotos) createFrame();
  }

  function updateCaption() {
    if (photos.length === maxPhotos) createFrame();
  }

  // ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ 1 ‡∏ä‡πá‡∏≠‡∏ï
  function takePhoto(isAuto = false) {
    if (photos.length >= maxPhotos) return;
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏à‡∏≤‡∏Å auto mode ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡πà‡∏≤‡∏¢ auto ‡∏≠‡∏¢‡∏π‡πà ‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏î‡∏¢‡∏¥‡∏á‡πÄ‡∏≠‡∏á
    if (!isAuto && isCapturing) return; 

    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");

    // ‡∏ù‡∏±‡∏á Filter + ‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô
    ctx.filter = currentFilter; 
    ctx.translate(canvas.width, 0);
    ctx.scale(-1, 1);
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    ctx.filter = 'none'; 

    const imgData = canvas.toDataURL("image/png");
    photos.push(imgData);

    const thumb = document.createElement("img");
    thumb.src = imgData;
    photosDiv.appendChild(thumb);

    // ‡∏ñ‡πâ‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ü‡∏£‡∏° (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Auto ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡πÑ‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≠‡∏ô‡∏à‡∏ö loop ‡πÄ‡∏≠‡∏á)
    if (!isCapturing && photos.length === maxPhotos) {
      createFrame();
    }
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
  function createFrame() {
    frameDiv.innerHTML = "";
    const caption = captionInput.value || "";
    
    const frameCanvas = document.createElement("canvas");
    const fctx = frameCanvas.getContext("2d");

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Padding (‡∏Ç‡∏≠‡∏ö) ‡πÉ‡∏´‡πâ‡πÄ‡∏¢‡∏≠‡∏∞‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥
    const padding = 50; 
    const gap = 20;
    const bottomSpace = 160;

    const images = [];
    let loaded = 0;

    photos.forEach((src, i) => {
      const img = new Image();
      img.src = src;
      img.onload = () => {
        images[i] = img;
        loaded++;
        if (loaded === maxPhotos) draw();
      };
    });

    function draw() {
      const w = images[0].width;
      const h = images[0].height;
      let canvasW, canvasH;

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î Canvas ‡∏ï‡∏≤‡∏° Layout
      if (currentLayout === 3) {
        canvasW = w + (padding * 2);
        canvasH = (h * 3) + (gap * 2) + (padding * 2) + bottomSpace;
      } else if (currentLayout === 4) {
        canvasW = (w * 2) + gap + (padding * 2);
        canvasH = (h * 2) + gap + (padding * 2) + bottomSpace;
      } else if (currentLayout === 6) {
        canvasW = (w * 2) + gap + (padding * 2);
        canvasH = (h * 3) + (gap * 2) + (padding * 2) + bottomSpace;
      }

      frameCanvas.width = canvasW;
      frameCanvas.height = canvasH;

      // 1. ‡∏ß‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
      fctx.fillStyle = frameBg;
      fctx.fillRect(0, 0, canvasW, canvasH);

      // 2. ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ
      images.forEach((img, i) => {
        let x, y;
        if (currentLayout === 3) {
            x = padding; y = padding + i * (h + gap);
        } else if (currentLayout === 4) {
            x = padding + (i%2)*(w+gap); y = padding + Math.floor(i/2)*(h+gap);
        } else if (currentLayout === 6) {
            x = padding + (i%2)*(w+gap); y = padding + Math.floor(i/2)*(h+gap);
        }
        fctx.drawImage(img, x, y, w, h);
      });

      // 3. ‡∏ß‡∏≤‡∏î Caption ‡∏´‡∏•‡∏±‡∏Å
      fctx.fillStyle = frameText;
      fctx.font = "800 52px 'Inter', sans-serif";
      fctx.textAlign = "center";
      fctx.fillText(caption, canvasW / 2, canvasH - 90);

      // 4. ‡∏ß‡∏≤‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
      fctx.font = "400 24px 'Inter', sans-serif";
      fctx.fillText(new Date().toLocaleDateString('en-GB'), canvasW / 2, canvasH - 40);

      // =========================================
      // 5. üî¥ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥ (Watermark) ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ üî¥
      // =========================================
      fctx.save(); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Canvas
      fctx.globalAlpha = 0.4; // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏à‡∏≤‡∏á‡∏•‡∏á (Opacity 40%)
      fctx.font = "600 16px 'Inter', sans-serif"; // ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏°‡∏¥‡∏ô‡∏¥‡∏°‡∏≠‡∏•
      fctx.fillStyle = frameText; // ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
      fctx.textAlign = "right";
      fctx.letterSpacing = "1px";
      // ‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á (‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà Padding)
      fctx.fillText("MILKBOX BY IG MARKENZ9", canvasW - (padding/2), canvasH - (padding/2));
      fctx.restore(); // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Canvas (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏ï‡πà‡∏≠)
      // =========================================


      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
      const finalImage = document.createElement("img");
      const finalImageDataURL = frameCanvas.toDataURL("image/png");
      finalImage.src = finalImageDataURL;
      frameDiv.appendChild(finalImage);

      // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° Download ‡πÅ‡∏•‡∏∞ Share ---
      const actionContainer = document.createElement("div");
      actionContainer.className = "final-actions";

      // ‡∏õ‡∏∏‡πà‡∏° Download
      const dlBtn = document.createElement("a");
      dlBtn.href = finalImageDataURL;
      dlBtn.download = "milkbox-studio.png";
      dlBtn.className = "action-button dl-btn";
      dlBtn.innerHTML = '<i class="fas fa-download"></i> Save Image';
      
      // ‡∏õ‡∏∏‡πà‡∏° Share (‡πÉ‡∏ä‡πâ Web Share API)
      const shareBtn = document.createElement("button");
      shareBtn.className = "action-button share-btn";
      shareBtn.innerHTML = '<i class="fas fa-share-alt"></i> Share';
      shareBtn.onclick = async () => {
          try {
              // ‡πÅ‡∏õ‡∏•‡∏á Data URL ‡πÄ‡∏õ‡πá‡∏ô Blob ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ä‡∏£‡πå
              const blob = await (await fetch(finalImageDataURL)).blob();
              const file = new File([blob], "milkbox-share.png", { type: blob.type });

              if (navigator.share) {
                  await navigator.share({
                      title: 'My MILKBOX Photo',
                      text: 'Check out my photo from MILKBOX STUDIO! @markenz9',
                      files: [file],
                  });
              } else {
                  alert("Your browser doesn't support direct sharing. Please save the image first.");
              }
          } catch (error) {
              console.error("Error sharing:", error);
          }
      };

      actionContainer.appendChild(dlBtn);
      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Browser ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏´‡∏° ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°
      if (navigator.canShare && navigator.canShare({ files: [new File([], 'test.png', {type:'image/png'})] })) {
          actionContainer.appendChild(shareBtn);
      }

      frameDiv.appendChild(actionContainer);
      // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏•‡∏á‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
      frameDiv.scrollIntoView({ behavior: 'smooth' });
    }
  }

  function resetApp(clearCaption = true) {
    if(isCapturing) return;
    photos = [];
    photosDiv.innerHTML = "";
    frameDiv.innerHTML = "";
    if(clearCaption) captionInput.value = "";
  }
</script>

</body>
</html>
