<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MILKBOX STUDIO</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Kanit:wght@300;400;600&display=swap');

    body {
      font-family: 'Inter', 'Kanit', sans-serif;
      background-color: #fafafa;
      color: #333;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    /* --- ANIMATIONS --- */
    @keyframes flashAnimation {
      0% { opacity: 1; }
      100% { opacity: 0; }
    }
    .flash-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: white; pointer-events: none; opacity: 0; z-index: 10;
    }
    .flash-active { animation: flashAnimation 0.15s ease-out; }

    /* --- MODALS --- */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(5px); z-index: 9999;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      text-align: center; transition: opacity 0.3s; opacity: 0; pointer-events: none;
    }
    .modal-overlay.open { opacity: 1; pointer-events: auto; }
    
    .modal-box {
      background: white; padding: 30px; border-radius: 24px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.15);
      max-width: 85%; width: 320px; position: relative;
    }
    .close-btn {
      position: absolute; top: 15px; right: 20px; font-size: 24px;
      cursor: pointer; color: #999; background: none; border: none;
    }
    
    /* NEW: Donation Button Style (Minimal) */
    .donate-btn-top {
      position: absolute; top: 20px; right: 20px;
      background: rgba(255,255,255,0.8); 
      backdrop-filter: blur(4px);
      border: 1px solid #eee; 
      border-radius: 30px; /* Capsule Shape */
      padding: 8px 16px;
      cursor: pointer; color: #333;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
      display: flex; align-items: center; justify-content: center; gap: 6px;
      font-size: 13px; font-weight: 600; font-family: 'Kanit', sans-serif;
      transition: 0.2s; z-index: 100;
    }
    .donate-btn-top:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
    .donate-btn-top i { color: #ff6b81; }

    /* NEW: Bank Card Style */
    .bank-card {
        background: #f8f9fa; border: 1px solid #eee; border-radius: 16px;
        padding: 20px; margin-top: 15px; text-align: left;
        display: flex; align-items: center; gap: 15px;
    }
    .bank-icon {
        width: 45px; height: 45px; background: #138f2d; color: white;
        border-radius: 10px; display: flex; align-items: center; justify-content: center;
        font-size: 20px; font-weight: bold;
    }
    .bank-details div { line-height: 1.4; }

    /* --- APP UI --- */
    .app-title-box { text-align: center; margin-bottom: 20px; margin-top: 10px; }
    .main-title { font-weight: 800; font-size: 26px; letter-spacing: 2px; margin: 0; }
    .sub-title { font-size: 12px; color: #666; letter-spacing: 1px; margin-top: 5px; }

    /* Camera */
    .camera-wrapper {
      position: relative; width: 100%; max-width: 350px; margin-bottom: 20px;
      border-radius: 20px; overflow: hidden; box-shadow: 0 15px 40px rgba(0,0,0,0.1);
      background: #000; aspect-ratio: 3/4;
    }
    video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

    /* Controls */
    .control-group {
      background: white; padding: 12px; border-radius: 16px;
      width: 100%; max-width: 360px; margin-bottom: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04); text-align: center;
    }
    .label { font-size: 10px; color: #aaa; margin-bottom: 6px; display: block; font-weight: 600; text-transform: uppercase; }
    
    .option-btn {
      border: 1px solid transparent; padding: 8px 12px; margin: 2px;
      border-radius: 10px; font-size: 12px; cursor: pointer;
      background: #f4f4f4; color: #666; transition: 0.2s;
    }
    .option-btn.active { background: #111; color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

    /* Auto Snap Button */
    .main-controls { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 20px 0; }
    .auto-snap-btn {
      width: 80px; height: 80px; border-radius: 50%;
      background: linear-gradient(135deg, #ff6b6b, #ee5253);
      border: 4px solid #fff; box-shadow: 0 10px 25px rgba(238, 82, 83, 0.4);
      cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center;
      color: white; font-weight: bold; font-size: 13px; line-height: 1.1; text-transform: uppercase;
      transition: transform 0.1s;
    }
    .auto-snap-btn:active { transform: scale(0.95); }
    .auto-snap-btn.capturing { background: #ccc; box-shadow: none; pointer-events: none; }

    .icon-btn {
        background: white; border: none; width: 50px; height: 50px;
        border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        cursor: pointer; color: #333; font-size: 18px; transition: 0.2s;
    }

    input[type="text"] {
      border: none; background: #fff; padding: 15px; border-radius: 12px;
      width: 100%; max-width: 300px; text-align: center; font-family: inherit;
      outline: none; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 20px;
    }

    /* Sticker Bar */
    .sticker-bar {
      display: none; justify-content: center; gap: 10px; margin-bottom: 15px;
      background: white; padding: 10px; border-radius: 50px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    .sticker-btn { font-size: 24px; cursor: pointer; background: none; border: none; transition: 0.2s; }
    .sticker-btn:hover { transform: scale(1.2); }

    /* Result Area */
    #photos { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; min-height: 60px; }
    #photos img { width: 60px; height: 60px; object-fit: cover; border-radius: 10px; transform: scaleX(-1); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    #frame img { max-width: 100%; width: 340px; border-radius: 4px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }

    .final-actions { display: flex; gap: 10px; margin-top: 20px; margin-bottom: 50px; }
    .action-button {
        padding: 12px 24px; border-radius: 30px; text-decoration: none;
        font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px;
        cursor: pointer; border: none; transition: 0.2s;
    }
    .dl-btn { background: #000; color: white; }
    .share-btn { background: #fff; color: #333; border: 1px solid #ddd; }

    /* Overlay Text */
    #cameraOverlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      background: rgba(0,0,0,0.3); color: white; pointer-events: none; opacity: 0;
    }
    #cameraOverlay.active { opacity: 1; }
    #countdownNum { font-size: 80px; font-weight: 800; }
  </style>
</head>
<body>

<button class="donate-btn-top" onclick="toggleModal('donateModal')" title="Support Me">
  <i class="fas fa-mug-hot"></i> ‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô
</button>

<div id="welcomeModal" class="modal-overlay open">
  <div class="modal-box">
    <h1 style="margin:0; font-size:32px;">MILKBOX</h1>
    <p style="color:#666; margin-top:5px; font-size:12px;">BY IG MARKENZ9</p>
    <p style="font-size:14px; margin: 30px 0; color:#444;">
      Select Layout ‚Ä¢ Choose Filter ‚Ä¢ Auto Snap<br>
      ‡πÅ‡∏ï‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    </p>
    <button class="action-button dl-btn" style="margin: 0 auto;" onclick="closeWelcome()">TOUCH TO START</button>
  </div>
</div>

<div id="instructionModal" class="modal-overlay">
  <div class="modal-box">
    <button class="close-btn" onclick="toggleModal('instructionModal', false)">&times;</button>
    <div style="font-size: 40px; margin-bottom: 10px;">‚ú®</div>
    <h3 style="margin: 0 0 10px 0;">‡∏£‡∏π‡∏õ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß!</h3>
    <p style="font-size:14px; color:#555;">
      ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏Å‡∏£‡∏≠‡∏ö<br>
      ‡πÅ‡∏ñ‡∏°‡∏¢‡∏±‡∏á‡∏Å‡∏î Emoji ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡πä‡∏°‡∏•‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞!
    </p>
    <button class="action-button dl-btn" style="margin: 20px auto 0;" onclick="toggleModal('instructionModal', false)">‡πÇ‡∏≠‡πÄ‡∏Ñ ‡∏•‡∏∏‡∏¢‡πÄ‡∏•‡∏¢!</button>
  </div>
</div>

<div id="donateModal" class="modal-overlay">
  <div class="modal-box">
    <button class="close-btn" onclick="toggleModal('donateModal', false)">&times;</button>
    <h3 style="margin-top:0;">Support Me üíñ</h3>
    <p style="font-size:14px; color:#666;">‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡∏ú‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡∏ö</p>
    
    <div class="bank-card">
        <div class="bank-icon">K</div>
        <div class="bank-details">
            <div style="font-size:12px; color:#999; text-transform:uppercase; font-weight:600;">Kasikornbank</div>
            <div style="font-size:20px; font-weight:800; color:#138f2d; letter-spacing:1px; margin:2px 0;">036-851-7569</div>
            <div style="font-size:14px; font-weight:500;">‡∏ì‡∏±‡∏ê ‡∏≠‡∏≤‡∏ô‡∏∏‡∏†‡∏≤‡∏û‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå</div>
        </div>
    </div>
    
    <p style="font-size:12px; color:#aaa; margin-top:20px;">(‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö!)</p>
  </div>
</div>

<div class="app-title-box">
    <h1 class="main-title">MILKBOX</h1>
    <div class="sub-title">BY IG MARKENZ9</div>
</div>

<div class="camera-wrapper">
  <video id="video" autoplay playsinline></video>
  <div class="flash-overlay" id="flash"></div> <div id="cameraOverlay">
      <div id="countdownNum">3</div>
      <div style="background:rgba(255,255,255,0.2); padding:5px 15px; border-radius:20px; margin-top:10px; font-weight:600;" id="photoCounterText">Photo 1/4</div>
  </div>
</div>

<div class="control-group">
  <span class="label">Layout</span>
  <button onclick="setLayout(3, this)" class="option-btn">Strip (3)</button>
  <button onclick="setLayout(4, this)" class="option-btn active">Grid (4)</button>
  <button onclick="setLayout(6, this)" class="option-btn">Big (6)</button>
</div>

<div class="control-group">
  <span class="label">Skin & Tone</span>
  <button onclick="setFilter('brightness(1.1) contrast(0.9) saturate(1.05)', this)" class="option-btn active">‚ú® Wink</button>
  <button onclick="setFilter('none', this)" class="option-btn">Normal</button>
  <button onclick="setFilter('brightness(1.1) contrast(1.15) sepia(0.2)', this)" class="option-btn">üáØüáµ Film</button>
  <button onclick="setFilter('grayscale(100%) contrast(1.1)', this)" class="option-btn">‚òÅÔ∏è Mono</button>
</div>

<div class="control-group">
  <span class="label">Frame Style</span>
  <button onclick="setFrameType('white', this)" class="option-btn active">White</button>
  <button onclick="setFrameType('black', this)" class="option-btn" style="background:#333; color:#fff;">Black</button>
  <button onclick="setFrameType('gradient', this)" class="option-btn" style="background:linear-gradient(45deg, #ff9a9e, #fad0c4); color:#fff; text-shadow:0 1px 2px rgba(0,0,0,0.3);">Grad.</button>
  <button onclick="setFrameType('pattern', this)" class="option-btn">Pattern</button>
</div>

<div class="main-controls">
  <div id="autoSnapBtn" class="auto-snap-btn" onclick="startAutoCapture()">
      <span>AUTO</span><span>SNAP</span>
  </div>
  <button onclick="resetApp()" class="icon-btn" title="Reset"><i class="fas fa-redo"></i></button>
</div>

<input id="captionInput" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." oninput="updateFrame()">

<div id="stickerBar" class="sticker-bar">
    <button class="sticker-btn" onclick="addSticker('üíñ')">üíñ</button>
    <button class="sticker-btn" onclick="addSticker('‚ú®')">‚ú®</button>
    <button class="sticker-btn" onclick="addSticker('üéÄ')">üéÄ</button>
    <button class="sticker-btn" onclick="addSticker('üß∏')">üß∏</button>
    <button class="sticker-btn" onclick="addSticker('üçí')">üçí</button>
    <button class="sticker-btn" onclick="undoStickers()" style="font-size:14px; margin-left:10px;">‚ùå Clear</button>
</div>

<div id="photos"></div>
<div id="frame"></div>

<script>
  // --- Audio Context for Beep & Sound ---
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  
  function playBeep(freq = 800, duration = 0.1) {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.frequency.value = freq;
    osc.type = 'sine';
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
    osc.stop(audioCtx.currentTime + duration);
  }

  function playShutter() {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const bufferSize = audioCtx.sampleRate * 0.1; 
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }
    const noise = audioCtx.createBufferSource();
    noise.buffer = buffer;
    const gain = audioCtx.createGain();
    gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
    noise.connect(gain);
    gain.connect(audioCtx.destination);
    noise.start();
  }

  // --- Variables ---
  const video = document.getElementById("video");
  const photosDiv = document.getElementById("photos");
  const frameDiv = document.getElementById("frame");
  const captionInput = document.getElementById("captionInput");
  const autoSnapBtn = document.getElementById("autoSnapBtn");
  const flashElem = document.getElementById("flash");
  
  let photos = [];
  let maxPhotos = 4;
  let currentLayout = 4;
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô (Wink)
  let currentFilter = 'brightness(1.1) contrast(0.9) saturate(1.05)';
  let frameType = 'white'; 
  let isCapturing = false;
  let stickers = []; 

  // --- Modal Logic ---
  function toggleModal(id, show = true) {
    const el = document.getElementById(id);
    if(show) el.classList.add('open');
    else el.classList.remove('open');
  }

  function closeWelcome() {
    toggleModal('welcomeModal', false);
    startCamera();
  }

  // --- Camera & Capture ---
  function startCamera() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert("Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô HTTPS");
      return;
    }
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Filter ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ Video ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    video.style.filter = currentFilter;

    navigator.mediaDevices.getUserMedia({ 
      video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: "user" } 
    }).then(stream => { video.srcObject = stream; video.play(); })
      .catch(err => { console.error(err); alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á"); });
  }

  function startAutoCapture() {
    if (isCapturing || !video.srcObject) { if(!video.srcObject) startCamera(); return; }
    resetApp(false);
    isCapturing = true;
    document.body.classList.add('is-capturing');
    autoSnapBtn.classList.add('capturing');
    autoSnapBtn.innerHTML = "<span>STOP</span>";
    runCaptureSequence(0);
  }

  function runCaptureSequence(index) {
    if (index >= maxPhotos) { finishAutoCapture(); return; }

    document.getElementById("photoCounterText").innerText = `Photo ${index + 1}/${maxPhotos}`;
    document.getElementById("cameraOverlay").classList.add('active');

    let count = 3;
    document.getElementById("countdownNum").innerText = count;
    playBeep(600); 

    const timer = setInterval(() => {
        count--;
        if (count > 0) {
            document.getElementById("countdownNum").innerText = count;
            playBeep(600);
        } else {
            clearInterval(timer);
            document.getElementById("countdownNum").innerText = "CHEESE!";
            playBeep(1200, 0.2); 
            
            setTimeout(() => {
                flashElem.classList.add('flash-active');
                setTimeout(()=>flashElem.classList.remove('flash-active'), 200);
                playShutter(); 
                
                takePhoto(true);
                document.getElementById("cameraOverlay").classList.remove('active');
                setTimeout(() => runCaptureSequence(index + 1), 1500);
            }, 300);
        }
    }, 1000);
  }

  function finishAutoCapture() {
    isCapturing = false;
    document.body.classList.remove('is-capturing');
    autoSnapBtn.classList.remove('capturing');
    autoSnapBtn.innerHTML = "<span>AUTO</span><span>SNAP</span>";
    document.getElementById("stickerBar").style.display = "flex"; 
    updateFrame();
    toggleModal('instructionModal', true);
  }

  function takePhoto(isAuto) {
    if (photos.length >= maxPhotos) return;
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    
    ctx.filter = currentFilter;
    ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    ctx.filter = 'none';

    const imgData = canvas.toDataURL("image/png");
    photos.push(imgData);

    const thumb = document.createElement("img");
    thumb.src = imgData; photosDiv.appendChild(thumb);
    
    if(!isCapturing && photos.length === maxPhotos) {
        document.getElementById("stickerBar").style.display = "flex";
        updateFrame();
        toggleModal('instructionModal', true);
    }
  }

  // --- Configuration ---
  function setLayout(n, btn) {
    if (isCapturing) return;
    if (photos.length > 0 && !confirm("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Layout ‡∏£‡∏π‡∏õ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏ô‡∏∞?")) return;
    resetApp(); maxPhotos = n; currentLayout = n;
    setActive(btn);
  }
  function setFilter(f, btn) { currentFilter = f; video.style.filter = f; setActive(btn); }
  function setFrameType(t, btn) { frameType = t; setActive(btn); if(photos.length===maxPhotos) updateFrame(); }
  function setActive(btn) {
    btn.parentElement.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }

  // --- Sticker Logic ---
  function addSticker(emoji) {
    if(photos.length !== maxPhotos) return;
    stickers.push({
        text: emoji,
        x: Math.random() * 0.8 + 0.1, 
        y: Math.random() * 0.8 + 0.1,
        r: (Math.random() - 0.5) * 50 
    });
    updateFrame();
  }
  function undoStickers() { stickers = []; updateFrame(); }

  // --- Drawing Frame ---
  function updateFrame() {
    if (photos.length < maxPhotos) return;
    frameDiv.innerHTML = "";
    
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    const padding = 50; const gap = 20; const bottomSpace = 160;
    const caption = captionInput.value || "";

    const images = photos.map(src => {
        const img = new Image(); img.src = src; return img;
    });

    images[0].onload = () => {
        const w = images[0].width; const h = images[0].height;
        let cW, cH;

        if (currentLayout === 3) { cW = w + padding*2; cH = h*3 + gap*2 + padding*2 + bottomSpace; }
        else if (currentLayout === 4) { cW = w*2 + gap + padding*2; cH = h*2 + gap + padding*2 + bottomSpace; }
        else { cW = w*2 + gap + padding*2; cH = h*3 + gap*2 + padding*2 + bottomSpace; }

        canvas.width = cW; canvas.height = cH;

        // Draw Background
        if(frameType === 'white') { ctx.fillStyle = '#fff'; ctx.fillRect(0,0,cW,cH); }
        else if(frameType === 'black') { ctx.fillStyle = '#1a1a1a'; ctx.fillRect(0,0,cW,cH); }
        else if(frameType === 'gradient') {
            const grd = ctx.createLinearGradient(0,0,cW,cH);
            grd.addColorStop(0, "#ff9a9e"); grd.addColorStop(1, "#fad0c4");
            ctx.fillStyle = grd; ctx.fillRect(0,0,cW,cH);
        } else if(frameType === 'pattern') {
            ctx.fillStyle = '#fff'; ctx.fillRect(0,0,cW,cH);
            ctx.fillStyle = '#eee';
            for(let i=0; i<cW; i+=30) for(let j=0; j<cH; j+=30) ctx.beginPath(), ctx.arc(i,j,4,0,Math.PI*2), ctx.fill();
        }

        const textColor = frameType === 'black' ? '#fff' : '#000';

        // Draw Photos
        images.forEach((img, i) => {
            let x, y;
            if(currentLayout===3) { x=padding; y=padding+i*(h+gap); }
            else { x=padding+(i%2)*(w+gap); y=padding+Math.floor(i/2)*(h+gap); }
            ctx.drawImage(img, x, y, w, h);
        });

        // Draw Caption
        ctx.fillStyle = textColor; ctx.font = "800 52px 'Inter', sans-serif";
        ctx.textAlign = "center"; ctx.fillText(caption, cW/2, cH - 90);
        ctx.font = "400 24px 'Inter', sans-serif";
        ctx.fillText(new Date().toLocaleDateString('en-GB'), cW/2, cH - 40);

        // Watermark
        ctx.save(); ctx.globalAlpha = 0.5; ctx.font = "600 16px 'Inter'"; 
        ctx.textAlign = "right"; ctx.fillText("MILKBOX BY IG MARKENZ9", cW-padding/2, cH-padding/2);
        ctx.restore();

        // Draw Stickers
        stickers.forEach(s => {
            ctx.save();
            ctx.translate(s.x * cW, s.y * cH);
            ctx.rotate(s.r * Math.PI / 180);
            ctx.font = "80px serif"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(s.text, 0, 0);
            ctx.restore();
        });

        // Finalize
        const finalUrl = canvas.toDataURL("image/png");
        const finalImg = document.createElement("img");
        finalImg.src = finalUrl;
        frameDiv.appendChild(finalImg);
        createActionButtons(finalUrl);
    };
  }

  function createActionButtons(url) {
    const box = document.createElement("div"); box.className = "final-actions";
    
    // Save Button
    const dl = document.createElement("a");
    dl.href = url; dl.download = "milkbox-studio.png";
    dl.className = "action-button dl-btn";
    dl.innerHTML = '<i class="fas fa-download"></i> Save Image';

    // Smart Share Button
    const share = document.createElement("button");
    share.className = "action-button share-btn";
    share.innerHTML = '<i class="fas fa-share-alt"></i> Share';
    share.onclick = async () => {
        try {
            const blob = await (await fetch(url)).blob();
            const file = new File([blob], "milkbox.png", { type: blob.type });
            const shareData = {
                title: 'MILKBOX STUDIO',
                text: '‡∏°‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà MILKBOX! üì∏‚ú® ‡∏•‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏•‡∏¢‡∏ó‡∏µ‡πà: ',
                url: window.location.href, // ‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡πÄ‡∏ß‡πá‡∏ö
                files: [file] // ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            };
            
            if (navigator.share) await navigator.share(shareData);
            else alert("Browser ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡πÅ‡∏ö‡∏ö Smart Share");
        } catch (e) { console.log(e); }
    };

    box.appendChild(dl);
    if(navigator.canShare) box.appendChild(share);
    frameDiv.appendChild(box);
    frameDiv.scrollIntoView({behavior:'smooth'});
  }

  function resetApp(clear=true) {
    if(isCapturing) return;
    photos=[]; photosDiv.innerHTML=""; frameDiv.innerHTML=""; stickers=[];
    document.getElementById("stickerBar").style.display = "none";
    if(clear) captionInput.value="";
  }
</script>

</body>
</html>
